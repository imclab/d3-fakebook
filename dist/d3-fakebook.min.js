(function(){var t={}.hasOwnProperty,e=function(e,n){function r(){this.constructor=e}for(var i in n)t.call(n,i)&&(e[i]=n[i]);return r.prototype=n.prototype,e.prototype=new r,e.__super__=n.prototype,e};window.D3Fakebook={},D3Fakebook.legend=function(t){return t.each(function(){var e,n,r,i,a,s;return t=d3.select(this),e={},n={},s=d3.select(t.property("nearestViewportElement")),r=t.attr("data-style-padding")||5,i=t.selectAll(".legend-items").data([!0]),i.enter().append("g").attr("class","legend-items"),i.selectAll("g"),s.selectAll("[data-legend]").each(function(){var t;return t=d3.select(this),e[t.attr("data-legend")]={pos:t.attr("data-legend-pos")||this.getBBox().y,color:void 0!==t.attr("data-legend-color")?t.attr("data-legend-color"):t.style("none"!==t.style("fill")?"fill":"stroke")}}),s.selectAll("[data-legend-comparison]").each(function(){var t;return t=d3.select(this),n[t.attr("data-legend-comparison")]={pos:t.attr("data-legend-pos")||this.getBBox().y,color:void 0!==t.attr("data-legend-color")?t.attr("data-legend-color"):t.style("none"!==t.style("fill")?"fill":"stroke")}}),e=d3.entries(e),n=d3.entries(n),n.length?(a=t.selectAll(".legend-items-comparison").data([!0]),a.enter().append("g").attr("class","legend-items-comparison"),a.selectAll("g").attr("class","legend-items-comparison"),i.selectAll("text").data(e,function(t){return t.key}).call(function(t){return t.enter().append("text")}).call(function(t){return t.exit().remove()}).attr("y",function(t,e){return 1.5*e+"em"}).attr("x","0em").text(function(t){return t.key}),i.selectAll("line").data(e,function(t){return t.key}).call(function(t){return t.enter().append("line")}).call(function(t){return t.exit().remove()}).attr("y1",function(t,e){return 1.5*e-.4+"em"}).attr("y2",function(t,e){return 1.5*e-.4+"em"}).attr("x1","-0.5em").attr("x2","-2em").style("stroke",function(t){return t.value.color}).style("stroke-width","4"),a.selectAll("text").data(n,function(t){return t.key}).call(function(t){return t.enter().append("text")}).call(function(t){return t.exit().remove()}).attr("y",function(t,e){return 1.5*e+"em"}).attr("x","0em").text(function(t){return t.key}),a.selectAll("line").data(n,function(t){return t.key}).call(function(t){return t.enter().append("line")}).call(function(t){return t.exit().remove()}).attr("y1",function(t,e){return 1.5*e-.4+"em"}).attr("y2",function(t,e){return 1.5*e-.4+"em"}).attr("x1","-0.5em").attr("x2","-2.5em").style("stroke",function(t){return t.value.color}).style("stroke-width","4").style("stroke-dasharray","5, 5")):(i.selectAll("text").data(e,function(t){return t.key}).call(function(t){return t.enter().append("text")}).call(function(t){return t.exit().remove()}).attr("y",function(t,e){return 1.5*e+"em"}).attr("x","1em").text(function(t){return t.key}),i.selectAll("circle").data(e,function(t){return t.key}).call(function(t){return t.enter().append("circle")}).call(function(t){return t.exit().remove()}).attr("cy",function(t,e){return 1.5*e-.4+"em"}).attr("cx","-0.4em").attr("r","0.4em").style("fill",function(t){return t.value.color}))}),t},window.D3Fakebook||(window.D3Fakebook={}),D3Fakebook.Core=function(){function t(t,e){var n,r,i,a;if(null==e&&(e={}),!t)throw n=new Error("Fakebook Chart requires a node selector"),n.name="ArgumentError",n;this.opts=e,(r=this.opts).valueName||(r.valueName="value"),this.el=d3.select(t)[0][0],this.$el=d3.select(this.el),this.title=e.title,_.isUndefined(this.opts.showPoints)&&(this.opts.showPoints=!0),this.chartColors=this.opts.colors||["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"],null!=e.data&&(this.data=e.data),a={top:80,right:100,bottom:120,left:100},this.margin=_.extend(a,this.opts.margin),delete this.opts.margin,i={height:window.innerHeight<480?500:this.el.offsetHeight,width:window.innerWidth<480?900:this.el.offsetWidth},this.dimensions=_.extend(i,this.opts.dimensions),delete this.opts.dimensions,this.innerWidth=this.dimensions.width-this.margin.left-this.margin.right,this.innerHeight=this.dimensions.height-this.margin.top-this.margin.bottom}return t.prototype.render=function(){return this.createContainer(),this.buildChart()},t.prototype._setColorScale=function(t,e){var n,r,i;return n=_.clone(t),e&&_.isArray(e)&&(i=d3.values(e[0])),this.opts.positions&&_(this.opts.positions.length).times(function(t){return function(e){return _(t.opts.positions).contains(e)?void 0:n.splice(e,1)}}(this)),r=d3.scale.category20(),null!=this.color?this.colorAlt=r:this.color=r},t.prototype.setTickFormat=function(t){return t.tickFormat(function(t){return function(e){return t.formatValues(e)}}(this))},t.prototype.formatValues=function(t){var e,n,r;return r=d3.round(t,5),e=d3.format(",s"),n=e(r),"-0"===n&&(n="0"),n},t.prototype.displayNotice=function(t,e){return this.el.innerHTML='<div class="chart-notice"> <h4 class="chart-notice-title">'+t+'</h4> <p class="chart-notice-content">'+e+"</p></div>"},t.prototype.createContainer=function(){var t,e;return t=this.dimensions.height+(this.title?40:0),e=this.dimensions.width,this.svg=d3.select(this.el).append("svg").attr("width",this.dimensions.width).attr("height",this.dimensions.height+(this.title?40:0)).attr("viewBox","0 0 "+e+" "+t).attr("perserveaspectratio","xMinYMid").append("g").attr("transform","translate("+this.margin.left+", "+this.margin.top+")")},t.prototype.getTitle=function(){return this.title},t.prototype._getLegendVerticalOffset=function(t){var e,n;return e=this.dimensions.height,n=this.margin.top+this.margin.bottom,this.opts.legendOffset?n+=this.opts.legendOffset:n-=t?60:40,e-n},t.prototype.drawLegend=function(){var t,e,n,r,i,a,s,o,l;return this.opts.showLegend!==!1&&(i=null!=this.opts.yLabel?this.opts.yLabel.split(",")[0]:this.opts.legendTitle,s=null!=this.opts.yLabelComparison?this.opts.yLabelComparison:null,r=i,a=s,l=this._getLegendVerticalOffset(null!=a),n=a?20:0,this.svg.append("g").attr("class","legend").attr("transform","translate("+n+", "+l+")").style("font-size","12px").call(D3Fakebook.legend),a)?(e=this.dimensions.width,t=this.dimensions.width-this.margin.right-this.margin.left,o=this.svg,o.selectAll(".legend-items").each(function(){var t;return t=d3.select(this),t.append("text").text(r).attr("transform","translate(-30, -20)").style("font-size","10px").style("font-weight","bold")}),o.selectAll(".legend-items-comparison").each(function(){var t,e,r;return r=d3.select(this),r.append("text").text(a).attr("transform","translate(-30, -20)").style("font-size","10px").style("font-weight","bold"),t=o.select(".legend-items")[0][0],e=t.getBoundingClientRect(),n=parseInt(e.width,10)+40,l=0,r.attr("transform","translate("+n+", "+l+")")})):void 0},t.prototype.drawTitle=function(){return this.svg.append("text").attr("x",(this.dimensions.width-this.margin.left-this.margin.right)/2).attr("y",0-this.margin.top/2).attr("text-anchor","middle").attr("class","chart-title").text(function(t){return function(){var e;return e=t.getTitle(),e?e:null}}(this))},t.prototype.utils={round2:function(t){return t=parseFloat(t,10),+t.toFixed(2).replace(/\.00$/,""),t}},t}(),D3Fakebook.BarChart=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.buildChart=function(){var t,e,n,r,i,a,s,o,l;return r=this.buildData(),i=!1,_(r).each(function(t){return t.values.length?i=!0:void 0}),i?(a=this.findMax(r),s=this.findMin(r),0>a&&0>s&&(o=a,l=s,a=l,s=o),e=this.opts.colors||this.countryColors,this._setColorScale(e,r),this.x0=d3.scale.ordinal().rangeRoundBands([0,this.innerWidth],.1),this.x1=d3.scale.ordinal(),this.y=d3.scale.linear().range([this.innerHeight,0]),this.xAxis=this.createAxis("x",this.x0,"bottom"),this.yAxis=this.createAxis("y",this.y,"left",{size:{major:0-this.innerWidth,minor:0-this.innerWidth,end:0-this.innerWidth}}),n=this.setCountries(this.color,r),t=d3.keys(r[0]).filter(function(t){return"date"!==t&&"values"!==t}),this.x0.domain(r.map(function(t){return t.date})),this.x1.domain(t).rangeRoundBands([0,this.x0.rangeBand()]),this.y.domain([s,a]),this.drawChart(r)):void this.displayNotice("This dataset cannot be rendered.","There is insufficient data for this chart.")},n.prototype.findMin=function(t){var e;return e=d3.min(t,function(t){return d3.min(t.values,function(t){return t.value})}),Math.min(0,e)},n.prototype.findMax=function(t){var e;return e=d3.max(t,function(t){return d3.max(t.values,function(t){return t.value})})},n.prototype.createAxis=function(t,e,n,r){var i,a;return a={count:10,subdivide:!1,padding:10,size:{major:0,minor:0,end:0}},r=_.extend(a,r||{}),i=d3.svg.axis().scale(e).orient(n),t.match(/^y/)&&(i.ticks(r.count).tickSize(r.size.major,r.size.minor,r.size.end).tickPadding(r.padding),this.setTickFormat(i)),i},n.prototype.setCountries=function(t,e){return t.domain().map(function(t){return{name:t,values:e[t]}})},n.prototype.buildData=function(){var t,e,n;return t=this.data,e=_.keys(t),n=_.values(t),_(e).each(function(e){return t[e].values=[],_(t[e]).each(function(n,r){var i;return"date"===r||"values"===r||_(n).isNaN()?void 0:(i={name:r,value:+n,date:+t[e].date},"World"===r?t[e].values.unshift(i):t[e].values.push(i))})}),t},n.prototype.drawChart=function(t){return this.drawAxes(),this.drawBars(t),this.drawLegend(),this.drawTitle()},n.prototype.drawBars=function(t){var e,n;return n=function(t){var e,n;return e=d3.format("n"),n=e(t),"-0"===n&&(n="0"),n},e=this.svg.selectAll(".date").data(t).enter().append("g").attr("class","g").attr("transform",function(t){return function(e){return"translate("+t.x0(e.date)+",0)"}}(this)),e.selectAll("rect").data(function(t){return t.values}).enter().append("rect").attr("class","chart-bar").attr("width",this.x1.rangeBand()).attr("x",function(t){return function(e){return t.x1(e.name)}}(this)).attr("y",function(t){return function(e){return t.y(e.value)}}(this)).attr("title",function(t){return t.name}).attr("height",function(t){return function(e){return t.innerHeight-t.y(e.value)}}(this)).style("fill",function(t){return function(e){return t.color(e.name)}}(this)).attr("data-legend",function(t){return t.name}).attr("data-legend-color",function(t){return function(e){return t.color(e.name)}}(this)).attr("data-toggle","popover").attr("data-content",function(t){return function(e){return'<strong style="color: '+t.color(e.name)+';"> '+n(t.utils.round2(e.value))+" #</strong> "+e.date}}(this))},n.prototype.drawAxes=function(){return this.drawXAxis(),this.drawYAxis()},n.prototype.drawXAxis=function(){return this.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+this.innerHeight+")").call(this.xAxis)},n.prototype.drawYAxis=function(){var t,e;return e=0-this.opts.yLabelOffset||this.margin.left/6,t=this.svg.append("g").attr("class","y axis").call(this.yAxis).append("text").attr("transform","rotate(-90)translate(0, "+e+")").style("text-anchor","middle").attr("class","chart-label chart-label-y-axis"),t.append("tspan").attr("x","-160").attr("y","-4.2em").text(""+this.opts.yLabel)},n}(D3Fakebook.Core),D3Fakebook.LineChart=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.setDomain=function(t,e,n){return 0>e||e>10||(e=0),t.domain([e,n])},n.prototype.createAxis=function(t,e,n,r){var i,a;return a={count:10,padding:10,size:null},r=_.extend(a,r||{}),i=void 0,"x"===t?i=d3.svg.axis().scale(e).innerTickSize(10).outerTickSize(10).orient(n):t.match(/^y/)&&(i=d3.svg.axis().scale(e).orient(n).ticks(r.count).innerTickSize(r.size).outerTickSize(r.size).tickPadding(r.padding),this.setTickFormat(i)),i},n.prototype.drawChart=function(t,e){return this.drawAxes(t,e),this.drawLines(t,this.x,this.y0,this.color),e&&this.drawLines(e,this.x,this.y1,this.colorAlt,!0),this.drawLegend(),this.drawTitle()},n.prototype.drawAxes=function(t,e){return this.drawXAxis(),this.drawYAxis(),e?this.drawYAxis(!0):void 0},n.prototype.drawXAxis=function(){return this.svg.append("g").attr("class","x axis").attr("transform","translate(0, "+this.innerHeight+")").call(this.xAxis)},n.prototype.drawYAxis=function(t){var e,n,r,i,a,s,o,l,u;return t||(t=!1),l=t?this.y1:this.y0,o=0,t?(u=this.opts.yLabelComparisonOffset||this.innerWidth-this.margin.right/8,n=this.opts.yLabelComparison):(a=null!=this.opts.yLabelOffset?this.opts.yLabelOffset:this.margin.left/8,u=0-a,n=this.opts.yLabel),s=t?"translate("+this.innerWidth+", 0)":null,i=n,e=this.svg.append("g").attr("class","y axis"+(t?" comparison":"")),e.call(t?this.yAxisRight:this.yAxisLeft).selectAll(".tick").data(l.ticks(10),function(t){return t}).exit().classed("minor",!0).attr("transform",s),r=e.append("text").attr("transform","rotate(-90)translate("+o+", "+u+")").style("text-anchor","middle").attr("class","chart-label chart-label-y-axis"),r.append("tspan").attr("x","-160").attr("y",t?"3.2em":"-4.2em").text(),r.append("tspan").attr("x","-160").attr("y",t?"4.4em":"-3.0em").text(n)},n}(D3Fakebook.Core),D3Fakebook.TimeScaleLineChart=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.buildChart=function(){var t,e,n,r;return t=_.compact(this.buildData()),e=t[0],t[1]&&t[1].length&&(n=t[1]),r=e&&!!e.length,n&&(r=r&&!!n.length),r?(_(t.length).times(function(e){return function(n){var r;return r=e.chartColors,t[n].length?e._setColorScale(r,t[n]):void 0}}(this)),this.x=d3.time.scale().range([0,this.innerWidth]),this.y0=d3.scale.linear().range([this.innerHeight,0]),this.y1=d3.scale.linear().range([this.innerHeight,0]),this.xAxis=this.createAxis("x",this.x,"bottom"),this.yAxisLeft=this.createAxis("y0",this.y0,"left",{size:0-this.innerWidth}),this.yAxisRight=this.createAxis("y1",this.y1,"right",{size:this.innerWidth}),this.x.domain([this.findMin(e,"date",!1),this.findMax(e,"date",!1)]),this.setDomain(this.y0,this.findMin(e),this.findMax(e)),n&&this.setDomain(this.y1,this.findMin(n),this.findMax(n)),this.drawChart(e,n)):void this.displayNotice("This dataset cannot be rendered.","There is insufficient data for this chart.")},n.prototype.findMin=function(t,e,n){var r;return null==e&&(e="datum"),null==n&&(n=!0),r=d3.min(t,function(t){return d3.min(t.values,function(t){return t[e]})})},n.prototype.findMax=function(t,e,n){var r;return null==e&&(e="datum"),null==n&&(n=!0),r=d3.max(t,function(t){return d3.max(t.values,function(t){return t[e]})})},n.prototype.drawLines=function(t,e,n,r,i){var a,s,o,l,u,c,h,p,f,m,g,y;return i||(i=!1),a=d3.format("n"),l=d3.svg.line().x(function(t){return e(t.date)}).y(function(t){return n(t.datum)}),u=this.svg.selectAll(".dataset").data(t),m=u.enter().append("g").attr("class","series"),s="data-legend",o="data-legend-color",i&&(s+="-comparison"),m.append("path").attr("class","line").attr("d",function(t){return l(t.values)}).attr(s,function(t){return t.key}).attr(o,function(t){return r(t.key)}).style("stroke",function(t){return r(t.key)}).style("stroke-dasharray",i?"5, 5":null),this.opts.showPoints&&(h=5.2,g=1e3,c=.4,f=this.svg.append("g"),p=m.selectAll(".data-point").data(function(t){var e;return e=_.filter(t.values,function(t){return!_.isNaN(t.datum)})}),p.enter().append("circle").attr("class","data-point").style("opacity",c).attr("cx",function(t){return e(t.date)}).attr("cy",function(t){return n(t.datum)}).attr("r",function(){return h}).attr("title",function(t){return""+t.date.getFullYear()+" - "+t.datum}).style("fill",function(t){return r(t.country)}).on("mouseover",function(){return d3.select(this).transition().duration(250).style("opacity",1)}).on("mouseout",function(){return d3.select(this).transition().duration(250).style("opacity",c)})),this.opts.labelLines!==!0||this.opts.dualY?void 0:(y="translate("+e(d.value.date)+", "+n(d.value.datum)+")",m.append("text").datum(function(t){return{name:t.name,value:t.values[t.values.length-1]}}).attr("transform",function(){return y}).attr("y",5).attr("x",10).text(function(t){return t.name}))},n.prototype._nestData=function(t,e,n){var r,i,a,s,o;return e||(e=!1),o=this.opts.valueName,n&&(s=this.findMin(n,"date"),s=new Date(s).getFullYear(),a=this.findMax(n,"date"),a=new Date(a).getFullYear()),r=e?"dataComparison":"data",i=_.chain(t).pluck(r).compact().value(),null!=i&&i.length?(o=this.opts.valueName,i=_.chain(i).flatten().map(function(t){var e;return e={datum:+t.value,date:new Date(t.date,0,1)},e[o]=t[o],e}).value(),i=_.reject(i,function(t){return _.isNaN(t.datum)}),null!=a&&null!=s&&(i=_.reject(i,function(t){var e;return e=new Date(t.date,0,1).getFullYear(),s>e||e>a})),d3.nest().key(function(t){return t[o]}).entries(i)):(r=[],_.each(t,function(t){var e;return e={datum:+t[o],date:new Date(t.date)},r.push(e)}),d3.nest().key(function(t){return t[o]}).entries(r))},n.prototype.buildData=function(){var t,e,n,r;return r=this.opts.valueName,t=new RegExp(/\d{4}/),_.each(this.data,function(e){return e.data?_.map(e.data,function(t){return t[r]=e[r]}):e.dataComparison?_.map(e.dataComparison,function(t){return t[r]=e[r]}):_.map(e,function(n,r){var i;return"date"===r?(i=t.test(n)?new Date(n,0,1):new Date(n),e[r]=i):e[r]=+n})}),e=this._nestData(this.data,!1),this.opts.dualY&&(n=this._nestData(this.data,!0,e)),[e,n]},n}(D3Fakebook.LineChart)}).call(this);