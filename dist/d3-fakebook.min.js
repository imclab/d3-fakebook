(function(){"use strict";var t={}.hasOwnProperty,n=function(n,e){function r(){this.constructor=n}for(var i in e)t.call(e,i)&&(n[i]=e[i]);return r.prototype=e.prototype,n.prototype=new r,n.__super__=e.prototype,n};window.D3Fakebook={},D3Fakebook.Chart=function(){function t(t,n){var e,r,i;if(null==n&&(n={}),!t)throw e=new Error("Fakebook Chart requires a node selector"),e.name="ArgumentError",e;this.opts=n,this.el=d3.select(t)[0][0],this.$el=d3.select(this.el),this.title=n.title,n.indicatorTitle&&(this.indicatorTitle=n.indicatorTitle),null!=n.data&&(this.data=n.data),i={top:80,right:100,bottom:80,left:100},this.margin=_.extend(i,this.opts.margin),delete this.opts.margin,r={height:window.innerHeight<480?500:this.el.offsetHeight,width:window.innerWidth<480?900:this.el.offsetWidth},this.dimensions=_.extend(r,this.opts.dimensions),delete this.opts.dimensions,this.innerWidth=this.dimensions.width-this.margin.left-this.margin.right,this.innerHeight=this.dimensions.height-this.margin.top-this.margin.bottom}return t.prototype.render=function(){return this.createContainer()},t.prototype.chartColors=["#e69545","#5cb5dd","#6272d3","#5dc960","#e645cd","#a25cdd","#dd5c5c"],t.prototype._setColorScale=function(t,n){var e,r,i;return e=_.clone(t),n&&_.isArray(n)&&(i=d3.values(n[0])),this.opts.positions&&_(this.opts.positions.length).times(function(t){return function(n){return _(t.opts.positions).contains(n)?void 0:e.splice(n,1)}}(this)),r=d3.scale.ordinal().range(e),null!=this.color?this.colorAlt=r:this.color=r},t.prototype.setTickFormat=function(t){return t.tickFormat(function(t){return function(n){return t.formatValues(n)}}(this))},t.prototype.formatValues=function(t){var n,e,r;return r=d3.round(t,5),n=d3.format(",s"),e=n(r),"-0"===e&&(e="0"),e},t.prototype.createContainer=function(){var t,n;return t=this.dimensions.height+(this.title?40:0),n=this.dimensions.width,this.svg=d3.select(this.el).append("svg").attr("width",this.dimensions.width).attr("height",this.dimensions.height+(this.title?40:0)).attr("viewBox","0 0 "+n+" "+t).attr("perserveaspectratio","xMinYMid").append("g").attr("transform","translate("+this.margin.left+", "+this.margin.top+")")},t.prototype.getTitle=function(){return this.title},t.prototype._getLegendVerticalOffset=function(t){var n,e;return n=this.dimensions.height,e=this.margin.top,this.opts.legendOffset?e+=this.opts.legendOffset:t?e+=20:e=e,t&&!this.isLargeScreen&&(e+=this.smallScreenOffset),n-e},t.prototype.drawLegend=function(){var t,n,e,r,i,a,s,o;return this.opts.showLegend!==!1&&(i=null!=this.opts.yLabel?this.opts.yLabel.split(",")[0]:this.opts.legendTitle,s=null!=this.opts.yLabelComparison?_.str.strLeftBack(this.opts.yLabelComparison,", "):null,r=_.str.capitalize(i),a=s,o=this._getLegendVerticalOffset(null!=a),e=a?20:0,this.svg.append("g").attr("class","legend").attr("transform","translate("+e+", "+o+")").style("font-size","12px").call(d3.legend),a)?(n=this.dimensions.width,t=this.dimensions.width-this.margin.right-this.margin.left,this.svg.selectAll(".legend-items").each(function(){var t;return t=d3.select(this),t.append("text").text(r).attr("transform","translate(-30, -20)").style("font-size","10px").style("font-weight","bold")}),this.svg.selectAll(".legend-items-comparison").each(function(){var n,r;return r=d3.select(this),r.append("text").text(a).attr("transform","translate(-30, -20)").style("font-size","10px").style("font-weight","bold"),n=parseInt($(".legend-items-comparison").outerWidth(),10),e=t-t/2+20,o=0,r.attr("transform","translate("+e+", "+o+")")})):void 0},t.prototype.drawTitle=function(){return this.svg.append("text").attr("x",(this.dimensions.width-this.margin.left-this.margin.right)/2).attr("y",0-this.margin.top/2).attr("text-anchor","middle").attr("class","chart-title").text(function(t){return function(){var n;return n=t.getTitle(),n?n:null}}(this))},t}(),D3Fakebook.BarChartBuilder=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return n(e,t),e.prototype.buildChart=function(){var t,n,e,r,i,a,s,o,u;return r=this.buildData(),i=!1,_(r).each(function(t){return t.values.length?i=!0:void 0}),i?(a=this.findMax(r),s=this.findMin(r),0>a&&0>s&&(o=a,u=s,a=u,s=o),n=this.opts.colors||this.countryColors,this._setColorScale(n,r),this.x0=d3.scale.ordinal().rangeRoundBands([0,this.innerWidth],.1),this.x1=d3.scale.ordinal(),this.y=d3.scale.linear().range([this.innerHeight,0]),this.xAxis=this.createAxis("x",this.x0,"bottom"),this.yAxis=this.createAxis("y",this.y,"left",{size:{major:0-this.innerWidth,minor:0-this.innerWidth,end:0-this.innerWidth}}),e=this.setCountries(this.color,r),t=d3.keys(r[0]).filter(function(t){return"year"!==t&&"values"!==t}),this.x0.domain(r.map(function(t){return t.year})),this.x1.domain(t).rangeRoundBands([0,this.x0.rangeBand()]),this.y.domain([s,a]),setTimeout(function(){return $(".chart-bar").popover({container:"body",html:!0,trigger:"manual",placement:"top"},10)}),this.drawChart(r)):void this.displayNotice("This dataset cannot be rendered.","There is insufficient data for this chart.")},e.prototype.findMin=function(t){var n;return n=d3.min(t,function(t){return d3.min(t.values,function(t){return t.value})}),Math.min(0,n)},e.prototype.findMax=function(t){var n;return n=d3.max(t,function(t){return d3.max(t.values,function(t){return t.value})})},e.prototype.createAxis=function(t,n,e,r){var i,a;return a={count:10,subdivide:!1,padding:10,size:{major:0,minor:0,end:0}},r=_.extend(a,r||{}),i=d3.svg.axis().scale(n).orient(e),t.match(/^y/)&&(i.ticks(r.count).tickSize(r.size.major,r.size.minor,r.size.end).tickPadding(r.padding),this.setTickFormat(i)),i},e.prototype.setCountries=function(t,n){return t.domain().map(function(t){return{name:t,values:n[t]}})},e.prototype.buildData=function(){var t,n,e;return t=this.data,e=_.keys(t),n=_.values(t),_(e).each(function(n){return t[n].values=[],_(t[n]).each(function(e,r){var i;return"year"===r||"values"===r||_(e).isNaN()?void 0:(i={name:r,value:+e,year:+t[n].year},"World"===r?t[n].values.unshift(i):t[n].values.push(i))})}),t},e.prototype.drawChart=function(t){return this.drawAxes(),this.drawBars(t),this.drawLegend(),this.drawTitle()},e.prototype.drawBars=function(t){var n,e;return n=function(t){var n,e;return n=d3.format("n"),e=n(t),"-0"===e&&(e="0"),e},e=this.svg.selectAll(".year").data(t).enter().append("g").attr("class","g").attr("transform",function(t){return function(n){return"translate("+t.x0(n.year)+",0)"}}(this)),e.selectAll("rect").data(function(t){return t.values}).enter().append("rect").attr("class","chart-bar").attr("width",this.x1.rangeBand()).attr("x",function(t){return function(n){return t.x1(n.name)}}(this)).attr("y",function(t){return function(n){return t.y(n.value)}}(this)).attr("title",function(t){return t.name}).attr("height",function(t){return function(n){return t.innerHeight-t.y(n.value)}}(this)).style("fill",function(t){return function(n){return t.color(n.name)}}(this)).attr("data-legend",function(t){return t.name}).attr("data-legend-color",function(t){return function(n){return t.color(n.name)}}(this)).attr("data-toggle","popover").attr("data-content",function(t){return function(e){return'<strong style="color: '+t.color(e.name)+';"> '+n(parseFloat(e.value,10).round2())+" #</strong> "+e.year}}(this)).on("mouseover",function(){return $(this).popover("show")}).on("mouseout",function(){return $(this).popover("hide")})},e.prototype.drawAxes=function(){return this.drawXAxis(),this.drawYAxis()},e.prototype.drawXAxis=function(){return this.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+this.innerHeight+")").call(this.xAxis)},e.prototype.drawYAxis=function(){var t,n;return n=0-this.opts.yLabelOffset||this.margin.left/6,t=this.svg.append("g").attr("class","y axis").call(this.yAxis).append("text").attr("transform","rotate(-90)translate(0, "+n+")").style("text-anchor","middle").attr("class","chart-label chart-label-y-axis"),t.append("tspan").attr("x","-160").attr("y","-4.2em").text(""+_.str.words(this.opts.yLabel,", ")[0]),t.append("tspan").attr("x","-160").attr("y","-3.0em").text(_.str.words(this.opts.yLabel,", ")[1])},e}(D3Fakebook.Chart),D3Fakebook.LineChart=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return n(e,t),e.prototype.buildChart=function(){var t,n,e,r,i,a,s,o;return t=this.buildData(),r=t[0],i=t[1],_(t.length).times(function(n){return function(e){var r;return r=n.countryColors,n._setColorScale(r,t[e])}}(this)),this.x=d3.scale.linear().range([0,this.innerWidth]),this.y0=d3.scale.linear().range([this.innerHeight,0]),this.y1=d3.scale.linear().range([this.innerHeight,0]),this.xAxis=this.createAxis("x",this.x,"bottom"),this.yAxisLeft=this.createAxis("y0",this.y0,"left",{size:{major:0-this.innerWidth,minor:0-this.innerWidth,end:0-this.innerWidth}}),this.yAxisRight=this.createAxis("y1",this.y1,"right"),n=this.setCountries(this.color,r),i&&(e=this.setCountries(this.colorAlt,i)),a=[],s=[],o=[],_(r).each(function(t,n){return _(r[n]).each(function(t){return a.push(t[0]),s.push(t[1])})}),i&&i.length&&_(i).each(v,k)(function(){return _(r[k]).each(function(t){return o.push(t[1])})}),this.x.domain(d3.extent(a)),this.setDomain(this.y0,this.findMin(s),this.findMax(s)),i&&this.setDomain(this.y1,this.findMin(o),this.findMax(o)),setTimeout(function(){return $(".data-point").popover({container:"body",html:!0,trigger:"manual",placement:"top"},10)}),this.drawChart(n,e)},e.prototype.setCountries=function(t,n){return t.domain().map(function(t){return{name:t,values:n[t]}})},e.prototype.setDomain=function(t,n,e){return 0>n||n>10||(n=0),t.domain([n,e])},e.prototype.createAxis=function(t,n,e,r){var i,a;return a={count:10,subdivide:!0,padding:10,size:{major:0,minor:0,end:0}},r=_.extend(a,r||{}),i=void 0,"x"===t?i=d3.svg.axis().scale(n).orient(e):t.match(/^y/)&&(i=d3.svg.axis().scale(n).orient(e).ticks(r.count).tickSubdivide(r.subdivide).tickSize(r.size.major,r.size.minor,r.size.end).tickPadding(r.padding),this.setTickFormat(i)),i},e.prototype.findMin=function(t){return d3.min(t)},e.prototype.findMax=function(t){return d3.max(t)},e.prototype.drawLines=function(t,n,e,r,i){var a,s,o,u,h,l,c,d,p,f;return i||(i=!1),u=d3.svg.line().defined(function(t){return t?!_.isNaN(t[0])&&!_.isNaN(t[1]):void 0}).x(function(t){return n(t[0])}).y(function(t){return e(t[1])}),h=this.svg.selectAll(".countries").data(t),a=h.enter().append("g").attr("class","country"),s="data-legend"+(i?"-comparison":void 0),o="data-legend-color",a.append("path").attr("class","line").attr("d",function(t){return u(t.values)}).attr(s,function(t){return t.name}).attr(o,function(t){return r(t.name)}).style("stroke",function(t){return r(t.name)}).style("stroke-dasharray",i?"5, 5":null),c=5.2,f=1e3,l=.4,p=this.svg.append("g"),d=a.selectAll(".data-point").data(function(t){var n;return n=_.filter(t.values,function(t){return!_.isNaN(t[0])&&!_.isNaN(t[1])}),_(n).each(function(n){return n.push(t.name)}),n}),d.enter().append("circle").attr("class","data-point").style("opacity",l).attr("cx",function(t){return n(t[0])}).attr("cy",function(t){return e(t[1])}).attr("r",function(){return c}).attr("title",function(t){return t[2]}).attr("data-toggle","popover").attr("data-content",function(t){return"X: "+parseFloat(t[0],10).round2()+" <br /> Y: "+parseFloat(t[1],10).round2()}).style("fill",function(t){return r(t[2])}).on("mouseover",function(){var t;return t=$(this),t.popover("show"),d3.select(this).transition().duration(250).style("opacity",1)}).on("mouseout",function(){var t;return t=$(this),t.popover("hide"),d3.select(this).transition().duration(250).style("opacity",l)}),d[0]&&d[0][0]&&null!=d[0][0].raphaelNode?_.each(d,function(t){return _.each(t,function(t){var n,e,r;return e=t.domNode["data-content"],r=t.domNode.title,n=$("[raphaelid='"+t.raphaelNode.id+"']"),n.addClass("data-point").attr("title",r).attr("data-content",e).attr("data-toggle","popover")})}):void 0},e.prototype.drawChart=function(t,n){return this.drawAxes(t,n),this.drawLines(t,this.x,this.y0,this.color),n&&this.drawLines(n,this.x,this.y1,this.colorAlt,!0),this.drawLegend(),this.drawTitle()},e.prototype.drawAxes=function(t,n){return this.drawXAxis(),this.drawYAxis(),n?this.drawYAxis(!0):void 0},e.prototype.drawXAxis=function(){return this.svg.append("g").attr("class","x axis").attr("transform","translate(0, "+this.innerHeight+")").call(this.xAxis)},e.prototype.drawYAxis=function(t){var n,e,r,i,a,s;return t||(t=!1),a=0,t?(s=this.opts.yLabelComparisonOffset||this.margin.right/8,n=this.opts.yLabelComparison):(s=0-this.opts.yLabelOffset,n=this.opts.yLabel),i=t?"translate("+this.innerWidth+", 0)":null,r=_.str.words(n,", ")[0],_.str.words(n,", ")[1]&&(r+=","),e=this.svg.append("g").attr("class","y axis").call(t?this.yAxisRight:this.yAxisLeft).attr("transform",i).append("text").attr("transform","rotate(-90)translate("+a+", "+s+")").style("text-anchor","middle").attr("class","chart-label chart-label-y-axis"),e.append("tspan").attr("x","-160").attr("y",t?"3.2em":"-4.2em").text(),e.append("tspan").attr("x","-160").attr("y",t?"4.4em":"-3.0em").text(_.str.words(n,", ")[1])},e.prototype.buildData=function(){var t,n,e,r,i,a;return _.each(this.data,function(t){return _.map(t.data,function(n){return n.country=t.country})}),e=_.compact(_.pluck(this.data,"country")),e||(e=_.compact(_.pluck(this.data,"name"))),r=_.compact(_.flatten(_.pluck(this.data,"data"))),i=_.compact(_.flatten(_.pluck(this.data,"dataComparison"))),r=_.flatten(r),t=_.uniq(_.pluck(r,"country")),n=_.groupBy(r,function(t){return t.country}),a=function(t){return n=void 0,t&&t.length&&(n={},_(t).each(function(t){return n[t.country]?n[t.country].push([t.xValue,t.yValue]):n[t.country]=[[t.xValue,t.yValue]]})),n},[a(r),a(i)]},e}(D3Fakebook.Chart),D3Fakebook.TimeScaleLineChart=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return n(e,t),e.prototype.buildChart=function(){var t,n,e,r;return t=_.compact(this.buildData()),n=t[0],t[1]&&t[1].length&&(e=t[1]),r=n&&!!n.length,e&&(r=r&&!!e.length),r?(_(t.length).times(function(n){return function(e){var r;return r=n.countryColors,t[e].length?n._setColorScale(r,t[e]):void 0}}(this)),this.x=d3.time.scale().range([0,this.innerWidth]),this.y0=d3.scale.linear().range([this.innerHeight,0]),this.y1=d3.scale.linear().range([this.innerHeight,0]),this.xAxis=this.createAxis("x",this.x,"bottom"),this.yAxisLeft=this.createAxis("y0",this.y0,"left",{size:{major:0-this.innerWidth,minor:0-this.innerWidth,end:0-this.innerWidth}}),this.yAxisRight=this.createAxis("y1",this.y1,"right"),this.x.domain([this.findMin(n,"date",!1),this.findMax(n,"date",!1)]),this.setDomain(this.y0,this.findMin(n),this.findMax(n)),e&&this.setDomain(this.y1,this.findMin(e),this.findMax(e)),setTimeout(function(){return $(".data-point").popover({container:"body",html:!0,trigger:"manual",placement:"top"},10)}),this.drawChart(n,e)):void this.displayNotice("This dataset cannot be rendered.","There is insufficient data for this chart.")},e.prototype.findMin=function(t,n,e){var r;return null==n&&(n="datum"),null==e&&(e=!0),r=d3.min(t,function(t){return d3.min(t.values,function(t){return t[n]})})},e.prototype.findMax=function(t,n,e){var r;return null==n&&(n="datum"),null==e&&(e=!0),r=d3.max(t,function(t){return d3.max(t.values,function(t){return t[n]})})},e.prototype.drawLines=function(t,n,e,r,i){var a,s,o,u,h,l,c,p,f,m,y,g;return i||(i=!1),s=d3.format("n"),h=d3.svg.line().x(function(t){return n(t.date)}).y(function(t){return e(t.datum)}),l=this.svg.selectAll(".countries").data(t),a=l.enter().append("g").attr("class","country"),o="data-legend",u="data-legend-color",i&&(o+="-comparison"),a.append("path").attr("class","line").attr("d",function(t){return h(t.values)}).attr(o,function(t){return t.key}).attr(u,function(t){return r(t.key)}).style("stroke",function(t){return r(t.key)}).style("stroke-dasharray",i?"5, 5":null),p=5.2,y=1e3,c=.4,m=this.svg.append("g"),f=a.selectAll(".data-point").data(function(t){var n;return n=_.filter(t.values,function(t){return!_.isNaN(t.datum)})}),f.enter().append("circle").attr("class","data-point").style("opacity",c).attr("cx",function(t){return n(t.date)}).attr("cy",function(t){return e(t.datum)}).attr("r",function(){return p}).attr("title",function(t){return t.country}).attr("data-toggle","popover").attr("data-content",function(t){return'<strong style="color: '+r(t.country)+'"> '+s(parseFloat(t.datum,10).round2())+" #</strong> "+t.date.getFullYear()}).style("fill",function(t){return r(t.country)}).on("mouseover",function(){var t;return t=$(this),t.popover("show"),d3.select(this).transition().duration(250).style("opacity",1)}).on("mouseout",function(){var t;return t=$(this),t.popover("hide"),d3.select(this).transition().duration(250).style("opacity",c)}),this.opts.labelLines!==!0||this.opts.dualY?void 0:(g="translate("+n(d.value.date)+", "+e(d.value.datum)+")",a.append("text").datum(function(t){return{name:t.name,value:t.values[t.values.length-1]}}).attr("transform",function(){return g}).attr("y",5).attr("x",10).text(function(t){return t.name}))},e.prototype._nestData=function(t,n,e){var r,i,a,s;return n||(n=!1),e&&(s=this.findMin(e,"date"),s=new Date(s).getFullYear(),a=this.findMax(e,"date"),a=new Date(a).getFullYear()),r=n?"dataComparison":"data",i=_.chain(t).pluck(r).compact().value(),null!=i&&i.length?(i=_.chain(i).flatten().map(function(t){return{country:t.country,datum:+t.value,date:new Date(t.year,0,1)}}).value(),i=_.reject(i,function(t){return _.isNaN(t.datum)}),null!=a&&null!=s&&(i=_.reject(i,function(t){var n;return n=new Date(t.date).getFullYear(),s>n||n>a})),d3.nest().key(function(t){return t.country}).entries(i)):null},e.prototype.buildData=function(){var t,n;return _.each(this.data,function(t){return _.map(t.data,function(n){return n.country=t.country})}),t=this._nestData(this.data,!1),this.opts.dualY&&(n=this._nestData(this.data,!0,t)),[t,n]},e}(D3Fakebook.LineChart)}).call(this);