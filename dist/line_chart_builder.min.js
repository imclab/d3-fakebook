(function(){var t={}.hasOwnProperty,n=function(n,r){function e(){this.constructor=n}for(var i in r)t.call(r,i)&&(n[i]=r[i]);return e.prototype=r.prototype,n.prototype=new e,n.__super__=r.prototype,n};define(["d3","underscore","./chart_builder"],function(t,r,e){var i;return i=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return n(i,e),i.prototype.buildChart=function(){var n,e,i,a,o,s,u,c;return n=this.buildData(),a=n[0],o=n[1],r(n.length).times(function(t){return function(r){var e;return e=t.countryColors,t._setColorScale(e,n[r])}}(this)),this.x=t.scale.linear().range([0,this.innerWidth]),this.y0=t.scale.linear().range([this.innerHeight,0]),this.y1=t.scale.linear().range([this.innerHeight,0]),this.xAxis=this.createAxis("x",this.x,"bottom"),this.yAxisLeft=this.createAxis("y0",this.y0,"left",{size:{major:0-this.innerWidth,minor:0-this.innerWidth,end:0-this.innerWidth}}),this.yAxisRight=this.createAxis("y1",this.y1,"right"),e=this.setCountries(this.color,a),o&&(i=this.setCountries(this.colorAlt,o)),s=[],u=[],c=[],r(a).each(function(t,n){return r(a[n]).each(function(t){return s.push(t[0]),u.push(t[1])})}),o&&o.length&&r(o).each(v,k)(function(){return r(a[k]).each(function(t){return c.push(t[1])})}),this.x.domain(t.extent(s)),this.setDomain(this.y0,this.findMin(u),this.findMax(u)),o&&this.setDomain(this.y1,this.findMin(c),this.findMax(c)),setTimeout(function(){return $(".data-point").popover({container:"body",html:!0,trigger:"manual",placement:"top"},10)}),this.drawChart(e,i)},i.prototype.setCountries=function(t,n){return t.domain().map(function(t){return{name:t,values:n[t]}})},i.prototype.setDomain=function(t,n,r){return 0>n||n>10||(n=0),t.domain([n,r])},i.prototype.createAxis=function(n,e,i,a){var o,s;return s={count:10,subdivide:!0,padding:10,size:{major:0,minor:0,end:0}},a=r.extend(s,a||{}),o=void 0,"x"===n?o=t.svg.axis().scale(e).orient(i):n.match(/^y/)&&(o=t.svg.axis().scale(e).orient(i).ticks(a.count).tickSubdivide(a.subdivide).tickSize(a.size.major,a.size.minor,a.size.end).tickPadding(a.padding),this.setTickFormat(o)),o},i.prototype.findMin=function(n){return t.min(n)},i.prototype.findMax=function(n){return t.max(n)},i.prototype.drawLines=function(n,e,i,a,o){var s,u,c,h,d,l,p,f,y,m;return o||(o=!1),h=t.svg.line().defined(function(t){return t?!r.isNaN(t[0])&&!r.isNaN(t[1]):void 0}).x(function(t){return e(t[0])}).y(function(t){return i(t[1])}),d=this.svg.selectAll(".countries").data(n),s=d.enter().append("g").attr("class","country"),u="data-legend"+(o?"-comparison":void 0),c="data-legend-color",s.append("path").attr("class","line").attr("d",function(t){return h(t.values)}).attr(u,function(t){return t.name}).attr(c,function(t){return a(t.name)}).style("stroke",function(t){return a(t.name)}).style("stroke-dasharray",o?"5, 5":null),p=5.2,m=1e3,l=.4,y=this.svg.append("g"),f=s.selectAll(".data-point").data(function(t){var n;return n=r.filter(t.values,function(t){return!r.isNaN(t[0])&&!r.isNaN(t[1])}),r(n).each(function(n){return n.push(t.name)}),n}),f.enter().append("circle").attr("class","data-point").style("opacity",l).attr("cx",function(t){return e(t[0])}).attr("cy",function(t){return i(t[1])}).attr("r",function(){return p}).attr("title",function(t){return t[2]}).attr("data-toggle","popover").attr("data-content",function(t){return"X: "+parseFloat(t[0],10).round2()+" <br /> Y: "+parseFloat(t[1],10).round2()}).style("fill",function(t){return a(t[2])}).on("mouseover",function(){var n;return n=$(this),n.popover("show"),t.select(this).transition().duration(250).style("opacity",1)}).on("mouseout",function(){var n;return n=$(this),n.popover("hide"),t.select(this).transition().duration(250).style("opacity",l)}),f[0]&&f[0][0]&&null!=f[0][0].raphaelNode?r.each(f,function(t){return r.each(t,function(t){var n,r,e;return r=t.domNode["data-content"],e=t.domNode.title,n=$("[raphaelid='"+t.raphaelNode.id+"']"),n.addClass("data-point").attr("title",e).attr("data-content",r).attr("data-toggle","popover")})}):void 0},i.prototype.drawChart=function(t,n){return this.drawAxes(t,n),this.drawLines(t,this.x,this.y0,this.color),n&&this.drawLines(n,this.x,this.y1,this.colorAlt,!0),this.drawLegend(),this.drawTitle()},i.prototype.drawAxes=function(t,n){return this.drawXAxis(),this.drawYAxis(),n?this.drawYAxis(!0):void 0},i.prototype.drawXAxis=function(){return this.svg.append("g").attr("class","x axis").attr("transform","translate(0, "+this.innerHeight+")").call(this.xAxis)},i.prototype.drawYAxis=function(t){var n,e,i,a,o,s;return t||(t=!1),o=0,t?(s=this.opts.yLabelComparisonOffset||this.margin.right/8,n=this.opts.yLabelComparison):(s=0-this.opts.yLabelOffset,n=this.opts.yLabel),a=t?"translate("+this.innerWidth+", 0)":null,i=r.str.words(n,", ")[0],r.str.words(n,", ")[1]&&(i+=","),e=this.svg.append("g").attr("class","y axis").call(t?this.yAxisRight:this.yAxisLeft).attr("transform",a).append("text").attr("transform","rotate(-90)translate("+o+", "+s+")").style("text-anchor","middle").attr("class","chart-label chart-label-y-axis"),e.append("tspan").attr("x","-160").attr("y",t?"3.2em":"-4.2em").text(),e.append("tspan").attr("x","-160").attr("y",t?"4.4em":"-3.0em").text(r.str.words(n,", ")[1])},i.prototype.buildData=function(){var t,n,e,i,a,o;return r.each(this.data,function(t){return r.map(t.data,function(n){return n.country=t.country})}),e=r.compact(r.pluck(this.data,"country")),e||(e=r.compact(r.pluck(this.data,"name"))),i=r.compact(r.flatten(r.pluck(this.data,"data"))),a=r.compact(r.flatten(r.pluck(this.data,"dataComparison"))),i=r.flatten(i),t=r.uniq(r.pluck(i,"country")),n=r.groupBy(i,function(t){return t.country}),o=function(t){return n=void 0,t&&t.length&&(n={},r(t).each(function(t){return n[t.country]?n[t.country].push([t.xValue,t.yValue]):n[t.country]=[[t.xValue,t.yValue]]})),n},[o(i),o(a)]},i}(e)})}).call(this);