(function(){var t,n={}.hasOwnProperty,e=function(t,e){function r(){this.constructor=t}for(var a in e)n.call(e,a)&&(t[a]=e[a]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};t=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.buildChart=function(){var t,n,e,r;return t=_.compact(this.buildData()),n=t[0],t[1]&&t[1].length&&(e=t[1]),r=n&&!!n.length,e&&(r=r&&!!e.length),r?(_(t.length).times(function(n){return function(e){var r;return r=n.countryColors,t[e].length?n._setColorScale(r,t[e]):void 0}}(this)),this.x=d3.time.scale().range([0,this.innerWidth]),this.y0=d3.scale.linear().range([this.innerHeight,0]),this.y1=d3.scale.linear().range([this.innerHeight,0]),this.xAxis=this.createAxis("x",this.x,"bottom"),this.yAxisLeft=this.createAxis("y0",this.y0,"left",{size:{major:0-this.innerWidth,minor:0-this.innerWidth,end:0-this.innerWidth}}),this.yAxisRight=this.createAxis("y1",this.y1,"right"),this.x.domain([this.findMin(n,"date",!1),this.findMax(n,"date",!1)]),this.setDomain(this.y0,this.findMin(n),this.findMax(n)),e&&this.setDomain(this.y1,this.findMin(e),this.findMax(e)),setTimeout(function(){return $(".data-point").popover({container:"body",html:!0,trigger:"manual",placement:"top"},10)}),this.drawChart(n,e)):void this.displayNotice("This dataset cannot be rendered.","There is insufficient data for this chart.")},n.prototype.findMin=function(t,n,e){var r;return null==n&&(n="datum"),null==e&&(e=!0),r=d3.min(t,function(t){return d3.min(t.values,function(t){return t[n]})})},n.prototype.findMax=function(t,n,e){var r;return null==n&&(n="datum"),null==e&&(e=!0),r=d3.max(t,function(t){return d3.max(t.values,function(t){return t[n]})})},n.prototype.drawLines=function(t,n,e,r,a){var i,u,o,s,l,c,h,f,p,y,m,v;return a||(a=!1),u=d3.format("n"),l=d3.svg.line().x(function(t){return n(t.date)}).y(function(t){return e(t.datum)}),c=this.svg.selectAll(".countries").data(t),i=c.enter().append("g").attr("class","country"),o="data-legend",s="data-legend-color",a&&(o+="-comparison"),i.append("path").attr("class","line").attr("d",function(t){return l(t.values)}).attr(o,function(t){return t.key}).attr(s,function(t){return r(t.key)}).style("stroke",function(t){return r(t.key)}).style("stroke-dasharray",a?"5, 5":null),f=5.2,m=1e3,h=.4,y=this.svg.append("g"),p=i.selectAll(".data-point").data(function(t){var n;return n=_.filter(t.values,function(t){return!_.isNaN(t.datum)})}),p.enter().append("circle").attr("class","data-point").style("opacity",h).attr("cx",function(t){return n(t.date)}).attr("cy",function(t){return e(t.datum)}).attr("r",function(){return f}).attr("title",function(t){return t.country}).attr("data-toggle","popover").attr("data-content",function(t){return'<strong style="color: '+r(t.country)+'"> '+u(parseFloat(t.datum,10).round2())+" #</strong> "+t.date.getFullYear()}).style("fill",function(t){return r(t.country)}).on("mouseover",function(){var t;return t=$(this),t.popover("show"),d3.select(this).transition().duration(250).style("opacity",1)}).on("mouseout",function(){var t;return t=$(this),t.popover("hide"),d3.select(this).transition().duration(250).style("opacity",h)}),this.opts.labelLines!==!0||this.opts.dualY?void 0:(v="translate("+n(d.value.date)+", "+e(d.value.datum)+")",i.append("text").datum(function(t){return{name:t.name,value:t.values[t.values.length-1]}}).attr("transform",function(){return v}).attr("y",5).attr("x",10).text(function(t){return t.name}))},n.prototype._nestData=function(t,n,e){var r,a,i,u;return n||(n=!1),e&&(u=this.findMin(e,"date"),u=new Date(u).getFullYear(),i=this.findMax(e,"date"),i=new Date(i).getFullYear()),r=n?"dataComparison":"data",a=_.chain(t).pluck(r).compact().value(),null!=a&&a.length?(a=_.chain(a).flatten().map(function(t){return{country:t.country,datum:+t.value,date:new Date(t.year,0,1)}}).value(),a=_.reject(a,function(t){return _.isNaN(t.datum)}),null!=i&&null!=u&&(a=_.reject(a,function(t){var n;return n=new Date(t.date).getFullYear(),u>n||n>i})),d3.nest().key(function(t){return t.country}).entries(a)):null},n.prototype.buildData=function(){var t,n;return _.each(this.data,function(t){return _.map(t.data,function(n){return n.country=t.country})}),t=this._nestData(this.data,!1),this.opts.dualY&&(n=this._nestData(this.data,!0,t)),[t,n]},n}(LineChartBuilder)}).call(this);