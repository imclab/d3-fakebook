(function(){var t={}.hasOwnProperty,n=function(n,e){function r(){this.constructor=n}for(var a in e)t.call(e,a)&&(n[a]=e[a]);return r.prototype=e.prototype,n.prototype=new r,n.__super__=e.prototype,n};define(["underscore","src/line_chart_builder"],function(t,e){var r;return r=function(e){function r(){return r.__super__.constructor.apply(this,arguments)}return n(r,e),r.prototype.buildChart=function(){var n,e,r,a;return n=t.compact(this.buildData()),e=n[0],n[1]&&n[1].length&&(r=n[1]),a=e&&!!e.length,r&&(a=a&&!!r.length),a?(t(n.length).times(function(t){return function(e){var r;return r=t.countryColors,n[e].length?t._setColorScale(r,n[e]):void 0}}(this)),this.x=d3.time.scale().range([0,this.innerWidth]),this.y0=d3.scale.linear().range([this.innerHeight,0]),this.y1=d3.scale.linear().range([this.innerHeight,0]),this.xAxis=this.createAxis("x",this.x,"bottom"),this.yAxisLeft=this.createAxis("y0",this.y0,"left",{size:{major:0-this.innerWidth,minor:0-this.innerWidth,end:0-this.innerWidth}}),this.yAxisRight=this.createAxis("y1",this.y1,"right"),this.x.domain([this.findMin(e,"date",!1),this.findMax(e,"date",!1)]),this.setDomain(this.y0,this.findMin(e),this.findMax(e)),r&&this.setDomain(this.y1,this.findMin(r),this.findMax(r)),setTimeout(function(){return $(".data-point").popover({container:"body",html:!0,trigger:"manual",placement:"top"},10)}),this.drawChart(e,r)):void this.displayNotice("This dataset cannot be rendered.","There is insufficient data for this chart.")},r.prototype.findMin=function(t,n,e){var r;return null==n&&(n="datum"),null==e&&(e=!0),r=d3.min(t,function(t){return d3.min(t.values,function(t){return t[n]})})},r.prototype.findMax=function(t,n,e){var r;return null==n&&(n="datum"),null==e&&(e=!0),r=d3.max(t,function(t){return d3.max(t.values,function(t){return t[n]})})},r.prototype.drawLines=function(n,e,r,a,i){var u,o,s,l,c,h,f,p,y,m,v,g;return i||(i=!1),o=d3.format("n"),c=d3.svg.line().x(function(t){return e(t.date)}).y(function(t){return r(t.datum)}),h=this.svg.selectAll(".countries").data(n),u=h.enter().append("g").attr("class","country"),s="data-legend",l="data-legend-color",i&&(s+="-comparison"),u.append("path").attr("class","line").attr("d",function(t){return c(t.values)}).attr(s,function(t){return t.key}).attr(l,function(t){return a(t.key)}).style("stroke",function(t){return a(t.key)}).style("stroke-dasharray",i?"5, 5":null),p=5.2,v=1e3,f=.4,m=this.svg.append("g"),y=u.selectAll(".data-point").data(function(n){var e;return e=t.filter(n.values,function(n){return!t.isNaN(n.datum)})}),y.enter().append("circle").attr("class","data-point").style("opacity",f).attr("cx",function(t){return e(t.date)}).attr("cy",function(t){return r(t.datum)}).attr("r",function(){return p}).attr("title",function(t){return t.country}).attr("data-toggle","popover").attr("data-content",function(t){return'<strong style="color: '+a(t.country)+'"> '+o(parseFloat(t.datum,10).round2())+" #</strong> "+t.date.getFullYear()}).style("fill",function(t){return a(t.country)}).on("mouseover",function(){var t;return t=$(this),t.popover("show"),d3.select(this).transition().duration(250).style("opacity",1)}).on("mouseout",function(){var t;return t=$(this),t.popover("hide"),d3.select(this).transition().duration(250).style("opacity",f)}),this.opts.labelLines!==!0||this.opts.dualY?void 0:(g="translate("+e(d.value.date)+", "+r(d.value.datum)+")",u.append("text").datum(function(t){return{name:t.name,value:t.values[t.values.length-1]}}).attr("transform",function(){return g}).attr("y",5).attr("x",10).text(function(t){return t.name}))},r.prototype._nestData=function(n,e,r){var a,i,u,o;return e||(e=!1),r&&(o=this.findMin(r,"date"),o=new Date(o).getFullYear(),u=this.findMax(r,"date"),u=new Date(u).getFullYear()),a=e?"dataComparison":"data",i=t.chain(n).pluck(a).compact().value(),null!=i&&i.length?(i=t.chain(i).flatten().map(function(t){return{country:t.country,datum:+t.value,date:new Date(t.year,0,1)}}).value(),i=t.reject(i,function(n){return t.isNaN(n.datum)}),null!=u&&null!=o&&(i=t.reject(i,function(t){var n;return n=new Date(t.date).getFullYear(),o>n||n>u})),d3.nest().key(function(t){return t.country}).entries(i)):null},r.prototype.buildData=function(){var n,e;return t.each(this.data,function(n){return t.map(n.data,function(t){return t.country=n.country})}),n=this._nestData(this.data,!1),this.opts.dualY&&(e=this._nestData(this.data,!0,n)),[n,e]},r}(e),window.TimeScaleLineChart=r})}).call(this);